<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet" Â  />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* background-image: url(/images/gray-scale-shot-black-watch.jpg); */
            background-color: rgba(103, 108, 103, 0.123);
            padding-top: 60px;
            /* Adjust according to your navigation bar height */
        }



        .cart-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, .5);
            margin: 20px auto;
        }

        .product-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #ddd;
            padding: 15px 0;
        }

        .product-details {
            display: flex;
            align-items: center;
        }

        .product-info {
            margin-left: 10px;
        }

        .product-info h4 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
        }

        .product-info p {
            margin: 5px 0;
            color: #666;
        }

        .product-image img {
            max-width: 80px;
            height: auto;
            border-radius: 4px;
            object-fit: cover;
        }

        .product-quantity {
            display: flex;
            align-items: center;
        }

        .quantity-btn {
            cursor: pointer;
            background-color: #4caf50;
            color: #fff;
            border: none;
            padding: 8px;
            border-radius: 4px;
            margin: 0 5px;
            transition: background-color 0.3s;
        }

        .quantity-btn:hover {
            background-color: #4dff00;
            color: black;
        }

        .buy-now-btn {
            background-color: #3498db;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .buy-now-btn:hover {
            background-color: #fff200;
            color: black;
            border: 10px;
        }

        .checkout-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .checkout-table {
            width: 100%;
            margin-top: 20px;
        }

        .checkout-table th,
        .checkout-table td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        .pl {
            width: 6em;
            height: 6em;
        }

        .pl__ring {
            animation: ringA 2s linear infinite;
        }

        .pl__ring--a {
            stroke: #f42f25;
        }

        .pl__ring--b {
            animation-name: ringB;
            stroke: #f49725;
        }

        .pl__ring--c {
            animation-name: ringC;
            stroke: #255ff4;
        }

        .pl__ring--d {
            animation-name: ringD;
            stroke: #f42582;
        }

        /* Animations */
        @keyframes ringA {

            from,
            4% {
                stroke-dasharray: 0 660;
                stroke-width: 20;
                stroke-dashoffset: -330;
            }

            12% {
                stroke-dasharray: 60 600;
                stroke-width: 30;
                stroke-dashoffset: -335;
            }

            32% {
                stroke-dasharray: 60 600;
                stroke-width: 30;
                stroke-dashoffset: -595;
            }

            40%,
            54% {
                stroke-dasharray: 0 660;
                stroke-width: 20;
                stroke-dashoffset: -660;
            }

            62% {
                stroke-dasharray: 60 600;
                stroke-width: 30;
                stroke-dashoffset: -665;
            }

            82% {
                stroke-dasharray: 60 600;
                stroke-width: 30;
                stroke-dashoffset: -925;
            }

            90%,
            to {
                stroke-dasharray: 0 660;
                stroke-width: 20;
                stroke-dashoffset: -990;
            }
        }

        @keyframes ringB {

            from,
            12% {
                stroke-dasharray: 0 220;
                stroke-width: 20;
                stroke-dashoffset: -110;
            }

            20% {
                stroke-dasharray: 20 200;
                stroke-width: 30;
                stroke-dashoffset: -115;
            }

            40% {
                stroke-dasharray: 20 200;
                stroke-width: 30;
                stroke-dashoffset: -195;
            }

            48%,
            62% {
                stroke-dasharray: 0 220;
                stroke-width: 20;
                stroke-dashoffset: -220;
            }

            70% {
                stroke-dasharray: 20 200;
                stroke-width: 30;
                stroke-dashoffset: -225;
            }

            90% {
                stroke-dasharray: 20 200;
                stroke-width: 30;
                stroke-dashoffset: -305;
            }

            98%,
            to {
                stroke-dasharray: 0 220;
                stroke-width: 20;
                stroke-dashoffset: -330;
            }
        }

        @keyframes ringC {
            from {
                stroke-dasharray: 0 440;
                stroke-width: 20;
                stroke-dashoffset: 0;
            }

            8% {
                stroke-dasharray: 40 400;
                stroke-width: 30;
                stroke-dashoffset: -5;
            }

            28% {
                stroke-dasharray: 40 400;
                stroke-width: 30;
                stroke-dashoffset: -175;
            }

            36%,
            58% {
                stroke-dasharray: 0 440;
                stroke-width: 20;
                stroke-dashoffset: -220;
            }

            66% {
                stroke-dasharray: 40 400;
                stroke-width: 30;
                stroke-dashoffset: -225;
            }

            86% {
                stroke-dasharray: 40 400;
                stroke-width: 30;
                stroke-dashoffset: -395;
            }

            94%,
            to {
                stroke-dasharray: 0 440;
                stroke-width: 20;
                stroke-dashoffset: -440;
            }
        }

        @keyframes ringD {

            from,
            8% {
                stroke-dasharray: 0 440;
                stroke-width: 20;
                stroke-dashoffset: 0;
            }

            16% {
                stroke-dasharray: 40 400;
                stroke-width: 30;
                stroke-dashoffset: -5;
            }

            36% {
                stroke-dasharray: 40 400;
                stroke-width: 30;
                stroke-dashoffset: -175;
            }

            44%,
            50% {
                stroke-dasharray: 0 440;
                stroke-width: 20;
                stroke-dashoffset: -220;
            }

            58% {
                stroke-dasharray: 40 400;
                stroke-width: 30;
                stroke-dashoffset: -225;
            }

            78% {
                stroke-dasharray: 40 400;
                stroke-width: 30;
                stroke-dashoffset: -395;
            }

            86%,
            to {
                stroke-dasharray: 0 440;
                stroke-width: 20;
                stroke-dashoffset: -440;
            }
        }

        .value-minus,
        .value-plus {
            height: 30px;
            line-height: 24px;
            width: 30px;
            margin-right: 3px;
            display: inline-block;
            cursor: pointer;
            position: relative;
            font-size: 18px;
            color: #fff;
            text-align: center;
            -webkit-user-select: none;
            -moz-user-select: none;
            border: 1px solid #b2b2b2;
            vertical-align: bottom;
            
        }

        .quantity-select .entry.value-minus:before,
        .quantity-select .entry.value-plus:before {
            content: "";
            width: 13px;
            height: 2px;
            background: #000;
            left: 50%;
            margin-left: -7px;
            top: 50%;
            margin-top: -0.5px;
            position: absolute;
        }

        .quantity-select .entry.value-plus:after {
            content: "";
            height: 13px;
            width: 2px;
            background: #000;
            left: 50%;
            margin-left: -1.4px;
            top: 50%;
            margin-top: -6.2px;
            position: absolute;
        }

        .value {
            cursor: default;
            width: 20px;
            height: 20px;
            padding: 8px 0px;
            color: #000000;
            line-height: 24px;
            text-align: center;
            display: inline-block;
            margin-right: 3px;
        }

        .quantity-select .entry.value-minus:hover,
        .quantity-select .entry.value-plus:hover {
            background: #E5E5E5;
        }

        .quantity-select .entry.value-minus {
            margin-left: 0;
        }
    </style>
</head>

<body>



    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-dark fixed-top p-2">
        <a style="color: #0F0;" class="navbar-brand" href=""><b><em>Fonekart</em></b></a>
        <button class="navbar-toggler bg-light" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class=" navbar-collapse" id="navbarNav" style="visibility: visible; justify-content: end;">
            <ul class="navbar-nav ml-auto " class="navv">

                <li class="nav-item">
                    <a style="color: white;" class="nav-link" href=" /home"> <i class="ri-home-8-line"></i></a>
                </li>
                <li class="nav-item">
                    <a style="color: white;" class="nav-link" href="/cart"><i class="ri-shopping-cart-line"></i></a>
                </li>
                <li class="nav-item">
                    <a style="color: white;" class="nav-link" href="/wishlist"><i class="ri-heart-line"></i></a>
                </li>
                <li class="nav-item">
                    <a style="color: white;" class="nav-link " href="/home/profile"><i
                            class="ri-account-circle-line"></i></a>
                </li>
                <!-- Add more navbar items as needed -->
            </ul>

        </div>
    </nav>

    <% if(cartData.length===0){ %>
        <div class="container bg-light mt-5"
            style="border: #3333332e 1px solid; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); border-radius: 5px;">
            <div class="text-center mt-5 pt-5 p-4">
                <svg class="pl" width="240" height="240" viewBox="0 0 240 240">
                    <circle class="pl__ring pl__ring--a" cx="120" cy="120" r="105" fill="none" stroke="#000"
                        stroke-width="20" stroke-dasharray="0 660" stroke-dashoffset="-330" stroke-linecap="round">
                    </circle>
                    <circle class="pl__ring pl__ring--b" cx="120" cy="120" r="35" fill="none" stroke="#000"
                        stroke-width="20" stroke-dasharray="0 220" stroke-dashoffset="-110" stroke-linecap="round">
                    </circle>
                    <circle class="pl__ring pl__ring--c" cx="85" cy="120" r="70" fill="none" stroke="#000"
                        stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
                    <circle class="pl__ring pl__ring--d" cx="155" cy="120" r="70" fill="none" stroke="#000"
                        stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
                </svg>
                <b>
                    <p class="mt-5 text-danger">Your cart is empty!</p>
                </b>
                <small>Add items to it now.</small>
                <br>
                <br>
                <a href="/home"><button
                        style="border-radius: 2px; width: 30%; border: 1px rgba(0, 0, 0, 0.116) solid; height: 40px;"
                        class="bg-info "><small>Shop now</small></button></a>
            </div>
        </div>
        <% } %>

            <div class="container">

                <div class="row ">
                    <div class="col-md-8">
                        <% if(cartData.length!==0){ %>
                            <div class="container cart-container ">
                                <% if(typeof cartData !=='undefined' ){ %>
                                    <h3 style="color: rgb(0, 159, 0);">Your shopping cart</h3>
                                    <% for(let i=0 ; i<cartData.length ; i++){ %>
                                        <div class="product-row p-2 mb-1"
                                            style="border-radius: 5px; border: #3333332e .2px solid;">
                                            <div class="product-details ">
                                                <div class="product-image">
                                                    <img src="<%= cartData[i].productDetails[0]?.images[0] %>"
                                                        alt="Product Image">
                                                </div>
                                                <div class="product-info">
                                                    <h4 style="color: black;">
                                                        <%= cartData[i].productDetails[0]?.Pname %>
                                                    </h4>
                                                    <p class="text-info">
                                                        <%= cartData[i].productDetails[0]?.Pcategory %>
                                                    </p>


                                                    <% if (cartData[i].offerDetails && cartData[i].offerDetails[0]) { %>
                                                        <del style="color: #33333376;">â¹ <%=
                                                                cartData[i].productDetails[0]?.price %></del>
                                                        <b class="text-success">
                                                            <%= cartData[i].offerDetails[0]?.discount %>% off
                                                        </b>
                                                        <br>
                                                        <b class="text-dark">â¹ <%= cartData[i].productDetails[0]?.price
                                                                - (cartData[i].productDetails[0]?.price *
                                                                cartData[i].offerDetails[0]?.discount / 100) %></b>
                                                        <% } else { %>
                                                            <b>â¹ <%= cartData[i].productDetails[0]?.price %></b>
                                                            <% } %>


                                                </div>
                                            </div>
                                            <!-- data-url="/api/updateCartQuantity?pid=<%#= cartData[i].productDetails[0]?._id %>" -->
                                            <div class="product-quantity quantity ">
                                                <td class="invert ">
                                                    <div class="quantity">
                                                        <div class="quantity-select">
                                                            <div class="entry value-minus"
                                                                data-id="<%= cartData[i].productDetails[0]?._id %>">
                                                                &nbsp;
                                                            </div>
                                                            <div class="entry value">
                                                                <span >
                                                                    <%= cartData[i].cartItems?.quantity %>
                                                                </span>
                                                            </div>
                                                            <input type="hidden"
                                                                value="<%= cartData[i].productDetails[0]?.quantity %>">
                                                            <div class="entry value-plus active"
                                                                data-id="<%= cartData[i].productDetails[0]?._id %>">
                                                                &nbsp;
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>


                                                <a href="#" class="delete-cart-item-btn"
                                                    data-product-id="<%= cartData[i].productDetails[0]?._id %>">
                                                    <button style="border-radius: 0;" class="buy-now-btn"><i
                                                            class="ri-delete-bin-5-line"></i></button>
                                                </a>

                                            </div>
                                        </div>
                                        <% } %>
                                            <% } %>
                                                <% } %>
                            </div>
                    </div>

                    <!-- Checkout Box -->
                    <% if (cartData && cartData?.length> 0) { %>
                        <div class="col-md-4 " style="padding-right: 0 ">
                            <div class="checkout-box mt-3 pe-5" style="background-color: rgb(255, 255, 255);">
                                <h2 style="margin-bottom: 50px; text-align: center;">Summary</h2>
                                <% let Subtotal=cartData?.reduce((total, item)=> {
                                    return total + (item?.cartItems?.quantity * item?.productDetails[0]?.price)
                                    }, 0) %>
                                    <% let Discount=cartData?.reduce((total, item)=> {
                                        if (item.offerDetails && item.offerDetails[0]) {
                                        return total + (item.cartItems.quantity * item.productDetails[0].price *
                                        item.offerDetails[0].discount / 100)
                                        } else {
                                        return total
                                        }
                                        }, 0) %>
                                        <p><b>Subtotal - </b><span style="margin-left: 50px;"><b
                                                    style="color: rgb(0, 0, 0);">â¹ <%= Subtotal.toFixed(2) %></b></span>
                                        </p>
                                        <p><b>Discount - </b><span style="margin-left: 50px;"><b
                                                    style="color: rgb(0, 0, 0);">â¹ <%= Discount.toFixed(2) %>
                                                </b></span></p>
                                        <p><b>Shipping - </b><span style="margin-left: 50px;"><b
                                                    style="color: green;">Free</b></span></p>
                                        <p><b>Total - </b><span style="margin-left: 80px;"><b style="color: crimson;">â¹
                                                    <%= (Subtotal - Discount).toFixed(2) %>
                                                </b></span></p>

                                        <!-- Checkout Button -->
                                        <a href="/cart/checkout"><button class="buy-now-btn">Proceed to
                                                Checkout</button></a>
                            </div>
                        </div>
                        <% } %>

                </div>
            </div>

            <footer class="bg-dark text-light pt-5  pb-3" id="footer" style=" margin-top: 150px;">
                <div class="container" style="padding: 30px;">
                    <div class="row">
                        <div class="col-md-4">
                            <a style="color: #0F0;" class="navbar-brand" href="#"><b><em>About Us</em></b></a>
                            <p>E-commerce platform</p>
                        </div>
                        <div class="col-md-4">
                            <a class="navbar-brand" href="#"><b style="color: #0F0;"><em>Contact Us</em></b></a>
                            <p>Email: Fonekart@gmail.com<br>Phone: 7558001145</p>
                        </div>
                        <div class="col-md-4">
                            <a style="color: #0F0;" class="navbar-brand" href="#"><b><em>Follow Us</em></b></a>
                            <ul class="list-inline">
                                <li class="list-inline-item"><a style="text-decoration: none;" class="text-light"
                                        href="https://wa.me/qr/QLG7ZQPTHYSDH1">Watsapp</a></li>
                                <br>
                                <li class="list-inline-item"><a style="text-decoration: none;" class="text-light"
                                        href="https://www.facebook.com/siyad.siyu.37?mibextid=ZbWKwL">Facebook</a>
                                </li>
                                <br>
                                <li class="list-inline-item"><a style="text-decoration: none;" class="text-light"
                                        href="https://instagram.com/siyad___._10?igshid=OGQ5ZDc2ODk2ZA==">Instagram</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>



            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
                crossorigin="anonymous"></script>
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


            <script>
                $(document).ready(function () {
                    $('.value-plus').on('click', function () {
                        var $container = $(this).closest('.quantity-select');
                        var $quantityDisplay = $container.find('.value');
                        var currentVal = parseInt($quantityDisplay.text(), 10);
                        var newVal = currentVal + 1;
                        var maxVal = parseInt($container.find('input[type="hidden"]').val(), 10);

                        if (newVal <= maxVal) {
                            $quantityDisplay.text(newVal);
                            var productId = $(this).attr('data-id');
                            updateCartQuantity(productId, newVal);
                        } else {
                            $('#quantityErrorMessage').text('Out of Stock');
                            $('#quantityErrorModal').modal('show');
                        }
                    });

                    $('.value-minus').on('click', function () {
                        var $container = $(this).closest('.quantity-select');
                        var $quantityDisplay = $container.find('.value');
                        var currentVal = parseInt($quantityDisplay.text(), 10);
                        var newVal = currentVal - 1;

                        if (newVal >= 1) {
                            $quantityDisplay.text(newVal);
                            var productId = $(this).attr('data-id');
                            updateCartQuantity(productId, newVal);
                        } else {
                            $('#quantityErrorMessage').text('Quantity cannot be less than 1.');
                            $('#quantityErrorModal').modal('show');
                        }
                    });

                    function updateCartQuantity(productId, quantityUpdate) {
                        $.ajax({
                            url: `/api/updateCartQuantity?pid=${productId}&qty=${quantityUpdate}`,
                            type: 'POST',
                            success: function (response) {
                                // Reload only the specific sections
                                $('.checkout-box').load(location.href + ' .checkout-box>*');
                                console.log('Quantity updated successfully');
                            },
                            error: function (error) {
                                console.error('Error updating quantity:', error);
                                $('#quantityErrorMessage').text('Quantity error: ' + error.responseJSON.message);
                                $('#quantityErrorModal').modal('show');
                            }
                        });
                    }
                });
            </script>



            <script>

                const deleteButtons = document.querySelectorAll('.delete-cart-item-btn');

                // Add click event listener to each button
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function (event) {
                        event.preventDefault()


                        const productId = button.dataset.productId;


                        Swal.fire({
                            title: 'Are you sure?',
                            text: 'You are about to delete this item from the cart.',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, delete it!',
                            cancelButtonText: 'Cancel'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = "/deleteCartItem?id=" + productId;
                            }
                        });
                    });
                });

            </script>


</body>

</html>